<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Admin - Rutas</title>
    <th:block th:replace="~{fragments/common :: headExtras}" />
</head>
<body>
<th:block th:replace="~{fragments/common :: navbar}" />
<h1>Rutas</h1>
<table>
    <thead><tr><th>Título</th><th>Autor</th><th>Acciones</th></tr></thead>
    <tbody>
        <tr th:each="r : ${rutas}">
            <td th:text="${r.titulo}">Título</td>
            <td th:text="${r.autor != null ? r.autor.nombre : 'Anónimo'}">Autor</td>
            <td>
                <!-- Usar sintaxis de Thymeleaf para path variables en lugar de concatenación -->
                <a th:href="@{/admin/rutas/{id}/editar(id=${r.idRuta})}">Editar</a>
                &nbsp;|&nbsp;
                <button type="button" th:attr="data-id=${r.idRuta}" onclick="deleteRuta(this.getAttribute('data-id'))">Eliminar</button>
            </td>
        </tr>
    </tbody>
</table>
<p><a href="/admin">Volver al panel</a></p>
<script th:inline="javascript">
    /*<![CDATA[*/
    var csrfMeta = document.querySelector('meta[name="_csrf"]');
    var csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
    var csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
    var csrfHeaderName = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : 'X-XSRF-TOKEN';

    function deleteRuta(id) {
        if (!confirm('¿Eliminar ruta id=' + id + '?')) return;
        var headers = {};
        if (csrfToken) headers[csrfHeaderName] = csrfToken;
        fetch('/api/rutas/' + id, { method: 'DELETE', credentials: 'include', headers: headers })
            .then(r => { if (r.status === 204 || r.ok) location.reload(); else r.text().then(t => alert('Error: ' + t)); })
            .catch(e => alert('Error de red: ' + e));
    }
    /*]]>*/
</script>
</body>
</html>
